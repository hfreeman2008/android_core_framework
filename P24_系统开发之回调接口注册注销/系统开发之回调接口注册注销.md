# P24: 系统开发之回调接口注册注销

<img src="../flower/flower_p24.png">

---

[<font face='黑体' color=#ff0000 size=40 >跳转到文章结尾</font>](#结束语)

---



# RemoteCallbackList：

在 Android 中，RemoteCallbackList 类是一个用于跨进程通信的工具类，可以用来注册、注销和通知客户端的回调接口。它在 Android 系统中广泛应用于各种系统服务和框架组件中，如通知服务、Activity 生命周期回调、媒体播放器等等。


# 什么是 RemoteCallbackList

RemoteCallbackList 是一个类似于列表的数据结构，它用于存储回调接口对象。
每个回调接口对象都有一个唯一的 Binder 标识符，可以用来在不同进程之间进行传递和跟踪。
RemoteCallbackList 的主要功能是提供了一组安全的 API，使得客户端可以注册、注销和通知回调接口对象，同时还提供了一些线程安全的方法，保证了并发操作的正确性。




# RemoteCallbackList 的使用

在使用 RemoteCallbackList 时，我们通常需要实现一个 Binder 服务或者一个 AIDL 接口，并在其中创建一个 RemoteCallbackList 对象。

这个对象会被用来存储客户端注册的回调接口对象。

以下是 RemoteCallbackList 的常用方法：

```java
register(T callback)：         注册一个回调接口对象。
unregister(T callback)：       注销一个回调接口对象。
beginBroadcast()：             开始通知客户端，返回客户端数量。
getBroadcastItem(int index)：  获取指定位置的回调接口对象。
finishBroadcast()：            通知客户端结束。
```






---

# 一个Demo例子


```java
public class MyBinder extends Binder {
    private RemoteCallbackList<MyCallback> mCallbacks = new RemoteCallbackList<>();

    public void registerCallback(MyCallback callback) {
        mCallbacks.register(callback);
    }

    public void unregisterCallback(MyCallback callback) {
        mCallbacks.unregister(callback);
    }

    public void notifyCallbacks(String message) {
        int count = mCallbacks.beginBroadcast();
        for (int i = 0; i < count; i++) {
            try {
                mCallbacks.getBroadcastItem(i).onMessageReceived(message);
            } catch (RemoteException e) {
                // do nothing
            }
        }
        mCallbacks.finishBroadcast();
    }
}

```

上面的例子中，我们创建了一个名为 MyBinder 的 Binder 服务，并在其中使用了 RemoteCallbackList 来实现注册、注销和通知回调接口对象。

当客户端调用 registerCallback 方法时，会将回调接口对象添加到 RemoteCallbackList 中；

当客户端调用 unregisterCallback 方法时，会将回调接口对象从 RemoteCallbackList 中移除；

当服务端需要通知客户端时，会调用 notifyCallbacks 方法，遍历 RemoteCallbackList 中所有的回调接口对象，并调用其相应的方法，实现回调的功能。


---


# Vibrator类注册OnVibratorStateChangedListener



## (1)app层

OnVibratorStateChangedListener接口方式



```java
private Vibrator mVibrator;  
mVibrator = InstrumentationRegistry.getContext().getSystemService(Vibrator.class);
或：
mVibrator =  (Vibrator) context.getSystemService(Context.VIBRATOR_SERVICE);

private OnVibratorStateChangedListener mListener1;

mListener1 = new Vibrator.OnVibratorStateChangedListener() {
    @Override
    public void onVibratorStateChanged(int state) {
        if (state == Vibrator.VIBRATOR_STATE_ON) {
            // 线性马达正在震动
        } else if (state == Vibrator.VIBRATOR_STATE_OFF) {
            // 线性马达停止震动
        }
    }
}

//添加OnVibratorStateChangedListener接口
mVibrator.addVibratorStateListener(mListener1);

//删除OnVibratorStateChangedListener接口
mVibrator.removeVibratorStateListener(mListener1);


```

---



```java



```


```makefile

```



```c

```


---




---

# 参考资料

Android源码之 RemoteCallbackList

https://blog.csdn.net/YoungOne2333/article/details/130622830


---

[<font face='黑体' color=#ff0000 size=40 >跳转到文章开始</font>](#p24-系统开发之回调接口注册注销)

---

# 结束语

<img src="../Images/end_001.png">
