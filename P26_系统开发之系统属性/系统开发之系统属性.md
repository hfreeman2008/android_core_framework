
# P26: 系统开发之系统属性

<img src="../flower/flower_p26.png">

---

[<font face='黑体' color=#ff0000 size=40 >跳转到文章结尾</font>](#结束语)

---

# 前言

系统属性是我们开发用的最多的一个技术点，以前觉得这个太简单了，没有什么需要了解的；后来想整体了解一下其具体的实现，发现事情没有那边简单啊。



本笔记主要是基于android 11，同步参考--Android 系统属性（SystemProperties）介绍（https://juejin.cn/post/7274932704453672972#heading-0）。

---

# 常用技巧

读取所有设备的系统属性：

```sh
adb shell getprop
```

读取对应的系统属性值（以sys.boot.reason为例）：


```sh
adb shell getprop sys.boot.reason
```

设置系统属性值（这个需要注意，许多系统属性值需要权限）：

```sh
adb shell setprop log.tag.stats_log D
```

监听系统属性值状态：

system/core/rootdir/init.rc

```sh
on property:vold.decrypt=trigger_restart_framework
    # A/B update verifier that marks a successful boot.
    exec_start update_verifier
    class_start_post_data hal
    class_start_post_data core
    class_start main
    class_start late_start
    setprop service.bootanim.exit 0
    start bootanim
```

---

# 代码中使用属性

## java代码调用

### 对于有系统权限的应用

我们可以直接使用SystemProperties的读写接口：

```java
import android.os.SystemProperties;

SystemProperties.set("sys.boot_completed", "1");
int max = SystemProperties.getInt("tombstoned.max_anr_count", 64);

```



这要求android程序的权限提升到system权限，方法有下面二个：

- 1、在AndroidManifest.xml中，在manifest加入android:sharedUserId="android.uid.system"。

- 2、在Android.mk中，將LOCAL_CERTIFICATE := XXX修改成LOCAL_CERTIFICATE := platform。

---

### 普通应用

由于SystemProperties.java的API为系统API，普通应用无法直接使用，可以通过反射来get和set prop。

```java
package com.android.reflectiondemo;

import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
import android.util.Log;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        Log.d(TAG, "sys.isolated_storage_snapshot:"+getBoolean("sys.isolated_storage_snapshot", false));
    }
    
    public static boolean getBoolean(String key, boolean def) throws IllegalArgumentException {
        try {
            Class SystemPropertiesClass = Class.forName("android.os.SystemProperties");
            Method getBooleanMethod =
                    SystemPropertiesClass.getDeclaredMethod(
                            "getBoolean", String.class, boolean.class);
            getBooleanMethod.setAccessible(true);
            return (boolean) getBooleanMethod.invoke(SystemPropertiesClass, key, def);
        } catch (InvocationTargetException
                | IllegalAccessException
                | NoSuchMethodException
                | ClassNotFoundException e) {
            Log.e(TAG, "Failed to invoke SystemProperties.getBoolean()", e);
        }
        return def;
    }
}

```



---

## c++代码调用

这里以MPEG4Writer.cpp为例

frameworks\av\media\libstagefright\MPEG4Writer.cpp

```c++
#include <cutils/properties.h>
    ...
void MPEG4Writer::addDeviceMeta() {
    ...
    if (property_get("ro.build.version.release", val, NULL)
    ...
        if (property_get("ro.product.model", val, NULL)
    ...
}

```

在C++代码中使用prop需要：
- include <cutils/properties.h>
- Android.mk或Android.bp或Makefile中需要链接libcutils库

```sh
shared_libs: [
        ...
        "libcutils",
        ...

```

properties.h源码在：

system/core/libcutils/include/cutils/properties.h

```c
int property_get(const char* key, char* value, const char* default_value);
int property_set(const char *key, const char *value);
int property_list(void (*propfn)(const char *key, const char *value, void *cookie), void *cookie)
```

libcutils库文件：

```sh
/system/lib64/libcutils.so
/system/lib/libcutils.so
```



---

# 涉及的代码路径汇总如下

```sh
app
SystemProperties#get  SystemProperties#set

framework：
frameworks\base\core\java\android\os\SystemProperties.java

jni:
frameworks\base\core\jni\android_os_SystemProperties.cpp

system:
system\core\base\properties.cpp
system\core\init\init.cpp
system\core\init\property_service.cpp
system\core\init\main.cpp
system\core\property_service\libpropertyinfoparser\property_info_parser.cpp

bionic:
bionic\libc\bionic\system_property_set.cpp
bionic\libc\bionic\system_property_api.cpp
bionic\libc\system_properties\system_properties.cpp
bionic\libc\include\sys\_system_properties.h
bionic\libc\include\sys\system_properties.h
bionic\libc\system_properties\contexts_serialized.cpp
bionic\libc\system_properties\prop_area.cpp
```

---

# 系统属性架构设计如下

![系统属性架构设计](系统属性架构设计.png)


---

# 系统属性整体分层

![系统属性整体分层](系统属性整体分层.png)

---

```sh

```


```sh

```


```sh

```



---



---

```sh

```

---

```sh

```

---

```sh

```

---

```sh

```

---


---

---

---



---


---


---




---

# 参考资料


---

[<font face='黑体' color=#ff0000 size=40 >跳转到文章开始</font>](#p26-系统开发之系统属性)

---

# 结束语

<img src="../Images/end_001.png">