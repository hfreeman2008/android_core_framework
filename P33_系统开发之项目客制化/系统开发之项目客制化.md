# P33: 系统开发之项目客制化

<img src="../flower/flower_p23.png">

---

[跳转到readme](https://github.com/hfreeman2008/android_core_framework/blob/main/README-CN.md)


---

[<font face='黑体' color=#ff0000 size=40 >跳转到文章结尾</font>](#结束语)

---

[上一篇文章 P32_系统开发之IMS输入模块](https://github.com/hfreeman2008/android_core_framework/blob/main/P32_%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E4%B9%8BIMS%E8%BE%93%E5%85%A5%E6%A8%A1%E5%9D%97/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E4%B9%8BIMS%E8%BE%93%E5%85%A5%E6%A8%A1%E5%9D%97.md)






---


# 新建项目的步骤和说明


以新建一个i7s项目为例：

(1)添加lunch选择项目类型

device\qcom\common\vendorsetup.sh

```sh
add_lunch_combo i7s-user
add_lunch_combo i7s-userdebug
add_lunch_combo i7s-eng
```

(2)添加项目列表

vendor\qcom\proprietary\common\config\device-vendor.mk

```sh
PRODUCT_LIST += i7s
```

 (3) 对比当前项目名，新建一个i7s目录

device\qcom\i7s
 
然后对应来修改相关的信息。 

---

# 复制方式实现项目overlay

## 添加项目源代码的直接复制覆盖功能

build\make\overlay_codes_copy_hytera.sh

```sh
#!/bin/bash
#add  copy codes for different projects 2024_8_14 start
function copy() {
    local src=$1
    local des=$2
    echo "overlay_codes_copy_hytera.sh copy src : $src"
    echo "overlay_codes_copy_hytera.sh copy des : $des"
    if [ -d ${src} -a -d ${des} ]; then
        echo "cp -rf ${src}* ${des}"
        cp -rf ${src}* ${des}
    fi
}
function main()
{
    echo "*******do overlay codes copy hytera start********"
    echo "overlay_codes_copy_hytera.sh main src : $1"
    echo "overlay_codes_copy_hytera.sh main des : $2"
    copy $1 $2
    echo "*******do overlay codes copy hytera end********"
}
main $1 $2
#add  copy codes for different projects 2024_8_14 end
```
这个文件执行：

```sh
chmod 777 overlay_codes_copy_hytera.sh
```


build\make\envsetup.sh

```sh
function lunch()
{
.......    
    echo
    #add  copy codes for different projects 2024_8_14 start
    #local local_path=$PWD
    local local_path=`/bin/pwd`
    echo "local_path: $local_path"
    local overlay_codes_copy_file=$local_path/build/make/overlay_codes_copy_hytera.sh
    if [ -e $overlay_codes_copy_file ];then
        echo "$overlay_codes_copy_file file exist,copy file for different projects !!!!"
        echo "MOBILE_POLICE_VALUE $MOBILE_POLICE_VALUE"
        if [ $MOBILE_POLICE_VALUE = MOBILE_POLICE_VERSION ];then
            echo "mobile police project,copy cods"
            local mobile_police_src_file=$local_path/vendor/mobile_police/overlay_codes/
            echo "mobile_police_src_file $mobile_police_src_file"
            $overlay_codes_copy_file $mobile_police_src_file $local_path/
            ##. $overlay_codes_copy_file $mobile_police_src_file $local_path/
        fi
    else
        echo "$overlay_codes_copy_file file no exist!!!!"
    fi
    #add  copy codes for different projects 2024_8_14 end
    set_stuff_for_environment
    printconfig
    destroy_build_var_cache
}
```

对应的要客制化的源代码的位置为：

```sh
vendor\mobile_police\overlay_codes
```


---

## 复制具体contents.xml文件

device\qcom\i7s\non_hlos\contents.xml
 
要修改此路径为我们对应添加项目的路径:

out/target/product/i7s/
 
并且在脚本中:

在编译前复制对应项目的此文件:

copy_customer_overlay_code


```sh
 function copy_customer_overlay_code()
{
echo "copy_customer_overlay_code"
if [ -e $BUILD_AP_DIR/device/qcom/$BUILD_PROJECT_NAME/non_hlos ]; then
    chmod 777 contents.xml
    cp -rf $BUILD_AP_DIR/device/qcom/$BUILD_PROJECT_NAME/non_hlos/*   $SRC_DIR
    echo "end copy $BUILD_AP_DIR/device/qcom/$BUILD_PROJECT_NAME/non_hlos/* to SRC_DIR"
fi
}
```

---


## 直接复制文件来替换对应源码

build/make/core/envsetup.mk 

```sh
#add uvc camera interface
ifeq ($(strip $(TINNO_UVC_CAMERA_INTERFACE_SUPPORT)),bottom)

$(shell \cp -rf vendor/mediatek/uvc_camera_module/uvccameracode/Camera.java frameworks/base/core/java/android/hardware/Camera.java)

$(shell \cp -rf vendor/mediatek/uvc_camera_module/uvccameracode/android_hardware_Camera.cpp  frameworks/base/core/jni/android_hardware_Camera.cpp)

else ifeq ($(strip $(TINNO_UVC_CAMERA_INTERFACE_SUPPORT)),both)

$(shell \cp -rf vendor/mediatek/uvc_camera_module/uvccameracode/Camera.java frameworks/base/core/java/android/hardware/Camera.java)

$(shell \cp -rf vendor/mediatek/uvc_camera_module/uvccameracode/android_hardware_Camera.cpp  frameworks/base/core/jni/android_hardware_Camera.cpp)

else ifeq ($(strip $(TINNO_UVC_CAMERA_INTERFACE_SUPPORT)),no)

$(shell \cp -rf vendor/mediatek/uvc_camera_module/uvccameracode/android_source/Camera.java frameworks/base/core/java/android/hardware/Camera.java)

$(shell \cp -rf vendor/mediatek/uvc_camera_module/uvccameracode/android_source/android_hardware_Camera.cpp  frameworks/base/core/jni/android_hardware_Camera.cpp)

endif
```

---


## 配置项目的桌面布局文件

common\tools\do_overlay_copy.sh

```sh
#!/bin/bash

X_ROOT_PATH=
X_PROJECT_ID=

function Usage() {
    cat <<-EOT >&2

    Usage:
     ${SHELL_PROGRAM_NAME} <optstring> <parameters>
     ${SHELL_PROGRAM_NAME} [options] [--] <optstring> <parameters>
     ${SHELL_PROGRAM_NAME} [options] -o|--options <optstring> [options] [--] <parameters>

    Parse command options.

    Options:
     -r, --rootpath   <RootPath>            RootPath
     -d, --projectid  <ProjectID>           ProjectID

     -h, --help     display this help and exit
     -V, --version  output version information and exit

    version: 0.1
    See the code for more information.
    EOT
}

function main()
{
    echo "*******do overlay copy********"

    if [[ ${X_PROJECT_ID} == full_* ]]; then
        X_PROJECT_ID=${X_PROJECT_ID:5}
    fi
    #echo ${X_ROOT_PATH}
    #echo ${X_PROJECT_ID}
    X_OVERLAY_SCR_PATH=${X_ROOT_PATH}/../overlay/${X_PROJECT_ID}
    X_OVERLAY_DST_PATH=${X_ROOT_PATH}
    if [ -d ${X_OVERLAY_SCR_PATH} -a -d ${X_OVERLAY_DST_PATH} ]; then
        cp -rf ${X_OVERLAY_SCR_PATH}/* ${X_OVERLAY_DST_PATH}/
        echo "cp -rf ${X_OVERLAY_SCR_PATH}/* ${X_OVERLAY_DST_PATH}/"
    fi
}

if [ $# == 0 ] ; then
    Usage
    exit 0
fi

while true; do
  case "$1" in
        -h | --help | -v | --version)
            Usage
            exit 0
            ;;
        -r | --rootpath)
            shift
            X_ROOT_PATH=$1
            shift
            ;;
        -d | --projectid)
            shift
            X_PROJECT_ID=$1
            shift
            ;;
        *)
            #main
            break
            #exit 0
            ;;
  esac
done

main


```

build\make\envsetup.sh

```sh
function lunch()
{
    local answer

    if [ "$1" ] ; then
        answer=$1
    else
        print_lunch_menu
        echo -n "Which would you like? [aosp_arm-eng] "
        read answer
    fi

    local selection=

    if [ -z "$answer" ]
    then
        selection=aosp_arm-eng
    elif (echo -n $answer | grep -q -e "^[0-9][0-9]*$")
    then
        local choices=($(TARGET_BUILD_APPS= get_build_var COMMON_LUNCH_CHOICES))
        if [ $answer -le ${#choices[@]} ]
        then
            # array in zsh starts from 1 instead of 0.
            if [ -n "$ZSH_VERSION" ]
            then
                selection=${choices[$(($answer))]}
            else
                selection=${choices[$(($answer-1))]}
            fi
        fi
    else
        selection=$answer
    fi

    export TARGET_BUILD_APPS=

    local product variant_and_version variant version

    product=${selection%%-*} # Trim everything after first dash
    variant_and_version=${selection#*-} # Trim everything up to first dash
    if [ "$variant_and_version" != "$selection" ]; then
        variant=${variant_and_version%%-*}
        if [ "$variant" != "$variant_and_version" ]; then
            version=${variant_and_version#*-}
        fi
    fi

    if [ -z "$product" ]
    then
        echo
        echo "Invalid lunch combo: $selection"
        return 1
    fi

    TARGET_PRODUCT=$product \
    TARGET_BUILD_VARIANT=$variant \
    TARGET_PLATFORM_VERSION=$version \
    build_build_var_cache
    if [ $? -ne 0 ]
    then
        return 1
    fi

    export TARGET_PRODUCT=$(get_build_var TARGET_PRODUCT)
    export TARGET_BUILD_VARIANT=$(get_build_var TARGET_BUILD_VARIANT)
    if [ -n "$version" ]; then
      export TARGET_PLATFORM_VERSION=$(get_build_var TARGET_PLATFORM_VERSION)
    else
      unset TARGET_PLATFORM_VERSION
    fi
    export TARGET_BUILD_TYPE=release

    echo
+    # begin, add
+    ( [ -f device/xthink/common/tools/do_overlay_copy.sh ] \
+      && bash device/xthink/common/tools/do_overlay_copy.sh -r ${PWD} -d ${TARGET_PRODUCT} \
+      && echo "do_overlay_copy.sh done.")
    #generate XthinkFeature.java XthinkFeature.h XthinkFeature.mk
    ( cd device/xthink/common/PlatformFeature && bash GenFeatures.sh )
    #X-thinks end
    set_stuff_for_environment
    printconfig
    destroy_build_var_cache
}
```




---

## 表格配置项目

vendor/dists/scripts/project.csv

![csv_image](./image/csv_image.png)


build/make/make_SC780_AP.sh

```sh
FILENAME="vendor/dists/scripts/project.csv"
#当前编译的项目名
CUSTOM_PROJ_NAME=0
......
function get_custom_project_name(){
if [ ! -f "$FILENAME" ]; then
    echo "CSV file doesn't exist"
    exit
fi
i=0
num=0
while IFS=, read -r id_tmp pro_tmp; do
    id[$i]=${id_tmp}
    proj[$i]=${pro_tmp}
    i=`expr ${i} + 1`
    num=${i}
done < "$FILENAME"
##使用数组变量中的值
for ((i=0;i<${num};++i));
do
    current_id=${id[$i]}
    if [ "$current_id" -eq "$CUSTOM_VERSION" ]; then
        CUSTOM_PROJ_NAME=${proj[$i]}
        echo "current_id is $current_id"
        echo "current_proj is $CUSTOM_PROJ_NAME"
        break
    fi
done
}
......
if [ $CUSTOM_VERSION -ne 0 ]; then
get_custom_project_name
export CUSTOM_PROJ_NAME
fi
......

```


具体原理为：

```sh
#!/bin/bash
 
while IFS=, read -r column1 column3
do
  echo "Column 1: $column1 - Column 3: $column3"
done < data.csv
 
```
这个脚本会逐行读取data.csv文件，并将每行的第一个和第三个字段分别赋值给变量column1和column3


---


# 客制化项目的selinux权限文件




```sh

```

```sh

```



---






---











---

[<font face='黑体' color=#ff0000 size=40 >跳转到文章开始</font>](#p33-系统开发之项目客制化)

---


[上一篇文章 P32_系统开发之IMS输入模块](https://github.com/hfreeman2008/android_core_framework/blob/main/P32_%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E4%B9%8BIMS%E8%BE%93%E5%85%A5%E6%A8%A1%E5%9D%97/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E4%B9%8BIMS%E8%BE%93%E5%85%A5%E6%A8%A1%E5%9D%97.md)






---

# 结束语

<img src="../Images/end_001.png">